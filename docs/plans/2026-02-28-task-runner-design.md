# Task Runner ‚Äî Design Document

**Date:** 2026-02-28
**Status:** Approved

## Summary

A `devkit run` CLI command that autonomously picks up tasks from a Trello board and executes them using Claude Code. It polls a "Ready" list, executes each card's execution plan via `claude -p` with a task-executor skill, creates a PR per task with squash merge, and moves cards through the board (Ready ‚Üí In Progress ‚Üí Done/Failed).

Designed for overnight autonomous operation on a personal Mac.

## Design Decisions

### Architecture: Go CLI + Execution Skill (B+C Hybrid)

- **Go CLI** handles: polling, card management, git workflow, PR creation, error handling, logging
- **Claude Skill** handles: interpreting the execution plan, using superpowers (TDD, verification), writing code, committing
- Rationale: Go provides long-term maintainability (types, tests, credential reuse). Claude provides intelligent execution (can use skills, handle unexpected situations).

### Git Workflow: One PR Per Task, Squash Merge

- Each task runs on a `task/{card-id}-{slug}` branch
- PR is created via `gh pr create`, then merged via `gh pr merge --squash --auto`
- Main history stays clean (one commit per task), PR pages retain full diff detail
- Rationale: preserves reviewable history while keeping main linear

### Error Handling: Skip + Mark Failed

- Failed tasks move to a "Failed" list with an error comment
- Runner continues to the next card ‚Äî never blocks on a single failure
- Rationale: maximize overnight throughput

## Trello Board Convention

### Required Lists

| List Name | Purpose |
|-----------|---------|
| `Ready` | Cards with execution plans, waiting for runner |
| `In Progress` | Runner is currently executing |
| `Done` | Execution succeeded, PR merged |
| `Failed` | Execution failed, error in comments |

### Card Format

- **Card name**: Human-readable task title
- **Card description**: Complete execution plan (generated by `writing-plans` skill)
- Cards processed top-to-bottom in Ready list (position = priority)

## CLI Interface

```
devkit run [flags]

Flags:
  --board <name>         Trello board name (required)
  --interval <seconds>   Poll interval, default 300 (5 minutes)
  --timeout <minutes>    Per-task timeout, default 30
  --once                 Process one card and exit (for debugging)
  --dry-run              Print what would happen, don't execute
```

## Main Loop

```
1. Initialize
   a. Read Trello credentials (reuse internal/config)
   b. Resolve board name ‚Üí board ID
   c. Resolve list names ‚Üí list IDs (Ready/In Progress/Done/Failed)

2. Loop
   a. GET cards from Ready list
   b. No cards ‚Üí sleep interval ‚Üí continue
   c. Take first card
   d. Move card ‚Üí In Progress
   e. git checkout main && git pull
   f. git checkout -b task/{card-id}-{slug}
   g. Read card description (execution plan)
   h. exec: claude -p --allowedTools '*' "{task-executor prompt + plan}"
   i. Check exit code:
      - Success (0):
        - gh pr create --title "{card name}" --body "{summary}"
        - gh pr merge --squash --auto
        - Move card ‚Üí Done
        - Comment: ‚úÖ + PR link + duration
      - Failure (non-0):
        - Move card ‚Üí Failed
        - Comment: ‚ùå + error summary + log path
   j. git checkout main && git pull
   k. --once? ‚Üí exit : continue loop
```

## Error Handling

| Scenario | Action |
|----------|--------|
| Trello API unreachable | Log, sleep, retry. Don't move any card |
| Card description empty | Move to Failed, comment "Empty plan" |
| `claude -p` exits non-0 | Move to Failed, comment with stderr summary |
| `claude -p` exceeds timeout | Kill process, move to Failed, comment "Timed out" |
| Move card API fails | Log error, continue to next card |

## Logging

- Stdout: `[2026-02-28 03:15:00] [INFO] Processing card: "Add auth endpoint"`
- Per-card Claude output saved to `~/.config/devkit/logs/{card-id}.log`

## Trello Comment Formats

Success:
```
‚úÖ Task completed by devkit runner
Duration: 12m34s
PR: https://github.com/user/repo/pull/42
```

Failure:
```
‚ùå Task failed
Duration: 5m12s
Error: tests failed in internal/auth/handler_test.go
See full log: ~/.config/devkit/logs/{card-id}.log
```

## PR Format

```markdown
Title: {card name}

## Task
{Trello card URL}

## Changes
{git diff --stat summary}

ü§ñ Executed by devkit runner
```

## File Structure

| File | Responsibility |
|------|---------------|
| `internal/cli/run.go` | Cobra command, flag parsing |
| `internal/runner/runner.go` | Main loop: poll ‚Üí dispatch ‚Üí handle result |
| `internal/runner/executor.go` | Invoke `claude -p`, capture output, timeout management |
| `internal/runner/git.go` | Branch creation, PR creation, squash merge |
| `internal/services/trello/client.go` | Trello HTTP client (extracted from existing curl patterns) |
| `internal/services/trello/types.go` | Board, List, Card type definitions |
| `.claude/skills/task-executor/SKILL.md` | Guides Claude on how to execute a task plan |

## Task Executor Skill

The skill instructs Claude to:
1. Parse the execution plan steps
2. Execute each step, using TDD and verification superpowers
3. Commit and push changes on completion
4. Exit non-0 with error details if blocked

Prompt template (assembled by Go):
```
Execute the following task plan. Use /superpowers:test-driven-development
and /superpowers:verification-before-completion skills during execution.

Task: {card_name}

Plan:
{card_description}

When done:
- Commit all changes with a descriptive message
- Push to the appropriate branch
```

## Non-Goals (v1)

- No parallel task execution (one card at a time)
- No web dashboard
- No auto-creating cards (only consumes Ready list)
- No cross-repo support (runs in current repo directory)
- No caffeinate/sleep prevention (user manages Mac settings)
